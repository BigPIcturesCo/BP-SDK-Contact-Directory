<!DOCTYPE html>
<html>
  <head>
    <title>Contact Directory</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300&display=swap" rel="stylesheet">
  </head>

  <body>
    
    <div id="directory" class="container-fluid" >
<!--       <div class="row pt-5" style="padding-bottom: 12px;"> -->
      <div class="" style="width: 664px; display:flex;">
        <div class="" style="width:320px;">
          <br>
          <div class="row" style="padding-left: 24px;">
            <div class="d-flex" style="position: relative;">
              <i 
                class="material-icons"
                style="position: absolute;left: 10px;top:10px; color:#C2C2C2;"
              >
                search
              </i>
              <input
                id="fullname"
                type="text"
                class="form-control form-control-sm mr-1 search-input"
                placeholder="Search"
                name="ipname"
              />
            </div>
            
          </div>
          <div class="row" style="margin-top: 12px;">
            <ul id="contact-list" class="list-group "> </ul>
          </div>
                    
        </div>
        <div class="" style="width: 344px; background-color: #FBFBFE">
          <div class="" style="height: 432px;  display:flex; flex-direction: column;">


                <div class="" style="padding-left: 106px;">
                  <img
                    id="profile-pic"
                    src="https://www.onap.org/wp-content/uploads/sites/20/2017/05/Blank_woman_placeholder.svg_-500x500.png"
                    class="rounded-circle"
                    alt="Profile pic"
                    width="132"
                    height="132"
                    style="margin-top: 30px; border-radius: 50%; object-fit: cover"
                  />

                  <p id="nochosen" class="text-primary" style="margin-top: -15px;">
                    &lt-- Select a user from the list
                  </p>
                </div>
             
                <div class="" style="padding-left: 56px;">
                  <p id="full-name" class="" style="margin-top: 54px;margin-bottom: 26px;;color: #474747; font-size:18px;">
                    
                  </p>
                  <div style="display:flex;">
                    <i class="material-icons">work</i>
                    <p id="profession" style="margin-left: 8px;color:#7a7a7a; font-size:14px;"> 
                    </p>
                  </div>
                  <div style="display:flex;">
                    <i class="material-icons material-icons-outlined">email</i>
                    <p id="email" style="margin-left: 8px;color:#7a7a7a; font-size:14px;"> 
                    </p>
                  </div>
                  <div style="display:flex;">
                    <i class="material-icons">phone_enabled</i>
                    <p id="mn" style="margin-left: 8px; color:#7a7a7a; font-size:14px;"> 
                    </p>
                  </div>
                  
                  <div style="display:flex;">
                    <i class="material-icons">cake</i>
                    <p id="bd" style="margin-left: 8px; color:#7a7a7a; font-size:14px;"> 
                    </p>
                  </div>
                  
<!--                   <div style="display:flex;">
                    <i class="material-icons">flag</i>
                    <p id="country" style="margin-left: 8px;"> 
                    </p>
                  </div> -->

              </div>
          </div>
        </div>
        
      </div>
    </div>
  </body>

  <script>
    
    
       async function getData() {
        const response = await BPSdk.dataSource.getData();
        return response.values;

        //uncomment this for testing

        // const data = [
        // ['First Name', 'Last Name', 'Directory', 'Email', 'Address', 'Phone Number', 'Country', 'Department', 'Skills & Expertise', 'Picture', 'About', 'Weight', 'Birth'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992'],
        // ['Sasha','ROUX','','sasha.roux@demo.com','','01 23 45 67 89','England,Accounting', 'Google Apps','','https://sites.google.com/a/revevol.eu/awesome-table-demo/female%20%2838%29.jpg','','49.8','07-13-1992']
        // ]

        // return data
      }

    
    $(document).ready(async function() {

      const dataSet = await getData();
    console.log(dataSet);
      const headers = dataSet.shift();
      const indexes = headers.reduce((indexObj, value, index) => {
        indexObj[value] = index;
        return indexObj;
      },{})

      const numOfPages = getNumOfPages(dataSet);
      const currentPage = 1;
      const next = nextPage(numOfPages);
      
      
      //Register next and previous
      $("#next").click(function() {
        const page = next(true);
        $("#pages").text(`${page}/${numOfPages}`)
        const pageContent = getItemForPage(dataSet, page);
        renderContactList(pageContent, indexes);
      });
      
      $("#previous").click(function() {
        const page = next(false);
        $("#pages").text(`${page}/${numOfPages}`);
        const pageContent = getItemForPage(dataSet, page);
        renderContactList(pageContent, indexes);
      });
      
      $("#pages").text(`${currentPage}/${numOfPages}`)
      const items = getItemForPage(dataSet, currentPage);
      renderContactList(items, indexes);
      $("#0").trigger("click");
    
      $("#fullname").on('input', function() {
        filterUser($(this).val(), items, indexes);
      });
      
    })
    
    const regex = /(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/i;
    
    const isTheValueAnURL = (url) => {
      console.log('url is', url);
      const parts = (url).toString().split('.');
      if(parts[0].indexOf('http') >=0 || parts[0].includes('active_storage')) return true;
      return false;
    }
    
    const detectURL = (url) => {
      let theUrl;
      subdomain = url.match(regex);
      domain = url.split('.')
      console.log('subdomain',subdomain)
      console.log('domain', domain)
      if(subdomain !== null){
    
        console.log('subdomain is',subdomain[1]);
        if(subdomain[1] === "drive" && domain[1] === "google") {
        theUrl = getImgSrcUrlFromDriveUrl(url);
        } else {
          theUrl = url;
        }
      } else {
      theUrl =  url;
      }
      return theUrl;
    }
    
    function getImgSrcUrlFromDriveUrl(url) {
      var id = getIdFromUrl(url);
      var prefix = 'https://drive.google.com/uc?export=view&id=';
      return prefix + id; 
    }
    function getIdFromUrl(url) { 
      return url.match(/[-\w]{20,}/); // some Drive files have 22 chars IDs !
    }
    
    function nextPage(numOfPages) {
      var currentPage = 1;
      return (order)=> {
        if(order) {
          if (currentPage >= numOfPages) {
            currentPage = 1;
            return currentPage;
          }
          currentPage += 1;
          return currentPage;
        } else {
          if (currentPage <= numOfPages) {
            currentPage = 1;
            return currentPage;
          }
          currentPage -= 1;
          return currentPage;
        }
      }
    }
    
    
    
      
    function getNumOfPages(dataSet) {
      return Math.ceil(dataSet.length / 8);
      
    }
    
    function getItemForPage(dataSet, page) {
      //The pagination is not user anymore
      // const startIndex = (page - 1) * 8;
      // const endIndex = page * 8
      // return dataSet.slice(startIndex, endIndex);
      return dataSet
    }
   
   function getPIC(row, picIndex){
     let picValue = row[picIndex];
     console.log('picValue is ', picValue);                                       
     let url;
       if(picValue === undefined || picValue === null) {
         return 'https://www.onap.org/wp-content/uploads/sites/20/2017/05/Blank_woman_placeholder.svg_-500x500.png'
       }
        if (isTheValueAnURL(picValue)){
          url = detectURL(picValue)
        }; 
        return url;
   }
    
   function renderContactList(list, indexes) {
     $('#contact-list').empty();

     const nameIndex = indexes['{{fullnameColumn}}'];
     const profIndex = indexes['{{professionColumn}}'];
     const countryIndex = indexes['{{countryColumn}}'];
     const birthdayindex = indexes['{{birthdayColumn}}'];
     const emailIndex = indexes['{{emailColumn}}'];
     const phoneIndex = indexes['{{phoneColumn}}'];
     const picIndex = indexes['{{profilePicColumn}}'];


     //Reference for test
    // ['First Name', 'Last Name', 'Directory', 'Email', 'Address', 'Phone Number', 'Country', 'Department', 'Skills & Expertise', 'Picture', 'About', 'Weight', 'Birth', 'date', 'Search'],
    
      //uncomment this for test
     // const nameIndex = 0;
     // const profIndex = 8;
     // const countryIndex = 6;
     // const birthdayindex = 12;
     // const emailIndex = 3;
     // const phoneIndex = 5;
     // const picIndex = 9;

                                       
     console.log('picIndex is', picIndex);

     jQuery.each(list, (index, row) => {
        const url = getPIC(row, picIndex);
        $('#contact-list').append(`
          <li 
            id="${index}"
            class="list-group-item">
            <img 
              src=${url}
              alt="profile pic" 
              width="40" height="40" 
              style="background-color: white; border-radius:50%; object-fit: cover"; 
              margin-bottom: -5px;"> 
            <section style="padding-left: 16px;">
              <span class="" style="color: #7a7a7a; font-size:14px;">
                ${row[nameIndex]}
              </span>
              <p style="color: #b3b3b3; font-size:13px;">
                ${row[emailIndex]}
              </p>
            <section>
          </li>`);

        selectUser(
          index,row, row[nameIndex], 
          row[profIndex], row[countryIndex], 
          row[birthdayindex], row[emailIndex], row[phoneIndex], url);
      }); 
   } 
   function filterUser(value, dataSet, indexes) {
     const searchTerm = value.toLowerCase();
     const filtered = dataSet.filter(row => {
       const fullName = `${row[0].toLowerCase()} ${row[1].toLowerCase()}`;
       
       return fullName.indexOf(value) !== -1;
     })
     console.log(filtered);
     renderContactList(filtered, indexes);
     
     
   }

   function selectUser(index, row, fullname, pro, ctr, bd, email, mn,url) {
          $("#nochosen").text("");
          $("#"+ index).click(function(){
          $(".list-group-item--selected").removeClass("list-group-item--selected");
          $("#"+ index).toggleClass('list-group-item--selected');
          $("#full-name").text(`${fullname}`);
          $("#profession").text(`${pro}`);
          $("#country").text(`${ctr}`);
          $("#bd").text(`${bd}`);
          $("#email").text(`${email}`);
          $("#mn").text(`${mn}`);
          $("#profile-pic").attr('src',url);    
        })
   }


  </script>

<style>
    #fullname {
      width: 280px;
      height: 40px;
      border-radius: 6px;
      border: 1px solid #E1DDEE;
      padding-left: 48px;
      color: #C2C2C2;
      outline: none;
    }
    @keyframes ld-container {
      0% {
        background: #666ce8;
      }

      12.5% {
        background: #666ce8;
      }

      12.625% {
        background: #1f2264;
      }

      100% {
        background: #1f2264;
      }
    }

    .ld-container div {
      position: absolute;
      width: 40px;
      height: 40px;
      background: #1f2264;
      animation: ld-container 1.0638297872340425s linear infinite;
    }

    .ld-blocks {
      width: 700px;
      height: 400px;
      display: inline-block;
      overflow: hidden;
      background: #ffffff;
    }

    .ld-container {
      width: 100%;
      height: 100%;
      position: relative;
      transform: translateZ(0) scale(1);
      backface-visibility: hidden;
      transform-origin: 0 0;
      /* see note above */
    }

    .ld-container div {
      box-sizing: content-box;
    }

    thead input {
      width: 100%;
    }
    
    .list-group {
      height: 368px;
      overflow: auto;
    }
    .list-group-item {
      display: flex;
      width: 320px;
      height: 72px;
      cursor: pointer;
      border: 0;
      border-bottom: 1px solid #E1DDEE;
    }
    .list-group-item--selected {
      background-color: #f1f1f1;
    }
    .search-input {
      width: 50%;
      outline: none;
    }
  </style>


</html>
